<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Promotion Portal</title>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b0d12;
      --card:#121622;
      --muted:#9aa3b2;
      --text:#e7ecf3;
      --accent:#6aa1ff;
      --accent-2:#22c55e;
      --border:#2a3142;
      --danger:#ef4444;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
      --radius-sm:12px;
      --gap:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;}
    body{
      margin:0; background: radial-gradient(1200px 800px at 10% -10%, #15203a 0%, transparent 60%),
                  radial-gradient(1000px 700px at 120% 20%, #18243f 0%, transparent 60%),
                  var(--bg);
      color:var(--text); font-family:"Inter",system-ui,-apple-system,Segoe UI,Roboto;
      -webkit-font-smoothing:antialiased; line-height:1.55;
    }
    .container{max-width:1100px; margin:48px auto; padding:0 20px;}
    .header{
      position:sticky; top:0; background:linear-gradient(to bottom, rgba(11,13,18,.85), rgba(11,13,18,0));
      backdrop-filter: blur(6px); padding:18px 0 6px; margin:-18px 0 12px 0; z-index:5;
    }
    h1{margin:0 0 4px 0; font-size:34px; letter-spacing:.2px}
    .subtitle{color:var(--muted); font-size:13px}

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow);
      padding:22px; margin:18px 0;
    }
    .card h3{margin:0 0 14px 0; font-size:18px}
    .grid{display:grid; gap:var(--gap)}
    .grid-2{grid-template-columns:1fr 1fr}
    @media (max-width:840px){ .grid-2{grid-template-columns:1fr} }

    label{display:block; font-weight:600; margin:2px 0 6px 2px; font-size:13px}
    .desc{color:var(--muted); font-size:12px; margin-left:6px}
    input,select,textarea{
      width:100%; appearance:none;
      background: #0f1422; color:var(--text);
      border:1px solid var(--border); border-radius:12px;
      padding:12px 14px; outline:none; transition:.15s border, .15s box-shadow;
    }
    input::placeholder, textarea::placeholder{color:#7d8899}
    input:focus, select:focus, textarea:focus{
      border-color: var(--accent);
      box-shadow: 0 0 0 4px rgba(106,161,255,.18);
    }
    textarea{min-height:92px; resize:vertical}

    .actions{display:flex; gap:10px; align-items:center}
    .btn{
      border:0; padding:12px 16px; border-radius:12px; cursor:pointer; font-weight:600;
      background:linear-gradient(180deg,#6aa1ff,#4f7ee6); color:white; box-shadow:0 6px 18px rgba(80,129,255,.35);
      transition: transform .06s ease;
    }
    .btn:hover{transform: translateY(-1px)}
    .btn:active{transform: translateY(0)}
    .btn.secondary{background:#1b2436}
    .muted{color:var(--muted); font-size:12px}

    .toolbar{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    .search{
      flex:1; min-width:220px;
      background:#0f1422; border:1px solid var(--border); border-radius:12px; padding:10px 14px;
      display:flex; gap:8px; align-items:center;
    }
    .search input{border:0; background:transparent; padding:0}
    .chip{display:inline-flex; gap:6px; align-items:center; font-size:12px; color:#cbd5e1;
          background:#172033; padding:6px 10px; border:1px solid var(--border); border-radius:999px}

    table{width:100%; border-collapse:separate; border-spacing:0; margin-top:14px}
    thead th{
      text-align:left; font-size:12px; letter-spacing:.3px; color:#cdd6e5;
      background:#121a2b; position:sticky; top:0; z-index:3;
    }
    th,td{padding:12px 10px; border-bottom:1px solid #1e2637}
    tbody tr:hover{background:#0f1422}
    .tbl-actions button{
      padding:8px 12px; border-radius:10px; border:1px solid var(--border); background:#141c2c; color:#e6ecf9;
    }
    .status{font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--border)}
    .status.approved{background:#10241a; color:#b1f5c6; border-color:#1e3b2a}
    .status.done{background:#1f2230; color:#c7cff9; border-color:#283056}
    .toast{font-size:12px; color:#b7ffcf; background:#0f2a1c; border:1px solid #1f5b39; padding:8px 12px; border-radius:10px; display:none}
    .toast.show{display:inline-block}
    .spacer{height:6px}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Promotion Portal</h1>
      <div class="subtitle">GitHub Pages + Google Apps Script + Google Sheets</div>
    </div>

    <!-- Create -->
    <div class="card">
      <h3>เพิ่มโปรโมชัน</h3>
      <form id="f" class="grid" autocomplete="off">
        <div class="grid grid-2">
          <div>
            <label>Promo Code</label>
            <input name="promo_code" placeholder="เช่น OCT25_EDM" required />
          </div>
          <div>
            <label>Name</label>
            <input name="name" placeholder="ชื่อแคมเปญ/รายละเอียดสั้น ๆ" required />
          </div>
        </div>

        <div class="grid grid-2">
          <div>
            <label>Start Date</label>
            <input type="date" name="start_date" required />
          </div>
          <div>
            <label>End Date</label>
            <input type="date" name="end_date" required />
          </div>
        </div>

        <div class="grid grid-2">
          <div>
            <label>Channel <span class="desc">EDM / SMS / In-Store / App</span></label>
            <input name="channel" placeholder="EDM" />
          </div>
          <div>
            <label>Budget</label>
            <input type="number" step="0.01" name="budget" placeholder="เช่น 50000" />
          </div>
        </div>

        <div class="grid grid-2">
          <div>
            <label>Discount (%)</label>
            <input type="number" step="0.01" name="discount" placeholder="เช่น 10" />
          </div>
          <div>
            <label>Owner</label>
            <input name="owner" placeholder="ผู้รับผิดชอบ" />
          </div>
        </div>

        <div>
          <label>Status <span class="desc">Draft / Approved / Live / Done</span></label>
          <input name="status" placeholder="Draft" />
        </div>

        <div>
          <label>Notes</label>
          <textarea name="notes" placeholder="เงื่อนไข / remark เพิ่มเติม"></textarea>
        </div>

        <div class="actions">
          <button class="btn" type="submit">Save</button>
          <span id="msg" class="toast">Saved ✓</span>
        </div>
      </form>
    </div>

    <!-- List -->
    <div class="card">
      <div class="toolbar">
        <div class="search">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.35-4.35M17 10.5A6.5 6.5 0 1 1 4 10.5a6.5 6.5 0 0 1 13 0Z" stroke="#94a3b8" stroke-width="1.6" stroke-linecap="round"/></svg>
          <input id="q" placeholder="ค้นหาชื่อ / โค้ด / เจ้าของ / สถานะ" />
        </div>
        <span class="chip" id="totalChip">0 รายการ</span>
      </div>
      <div class="spacer"></div>
      <div id="list"></div>
    </div>
  </div>

  <script>
    // <<< เปลี่ยนเป็น URL Apps Script ของบูม >>>
    const WEB_APP_URL = 'REPLACE_WITH_YOUR_APPS_SCRIPT_EXEC_URL';

    const $ = (s)=>document.querySelector(s);

    async function listPromos(){
      $('#list').innerHTML = '<div class="muted">Loading…</div>';
      try{
        const res = await fetch(WEB_APP_URL+'?t='+(Date.now())); // กัน cache
        const json = await res.json();
        if(!json.ok) throw new Error(json.error || 'Unknown error');
        window.__rows = json.data || [];
        renderTable(window.__rows);
      }catch(err){
        $('#list').innerHTML = '<div class="muted">Error: '+err.message+'</div>';
      }
    }

    function renderTable(rows){
      const q = ($('#q').value||'').toLowerCase().trim();
      const filtered = rows.filter(r=>{
        const s = `${r.promo_code||''} ${r.name||''} ${r.owner||''} ${r.status||''}`.toLowerCase();
        return !q || s.includes(q);
      });
      $('#totalChip').textContent = `${filtered.length} รายการ`;

      const html = [
        '<div class="table-wrap"><table>',
        '<thead><tr>',
          '<th>#</th><th>Time</th><th>Code</th><th>Name</th><th>Start</th><th>End</th>',
          '<th>Channel</th><th>Budget</th><th>Disc %</th><th>Owner</th><th>Notes</th><th>Status</th><th></th>',
        '</tr></thead><tbody>',
        filtered.map((r,i)=>{
          const rowIndexOneBased = 2 + (window.__rows||[]).indexOf(r); // header=1, data start=2
          const stClass = (r.status||'').toLowerCase()==='approved' ? 'approved'
                        : (r.status||'').toLowerCase()==='done' ? 'done' : '';
          return `<tr>
            <td>${i+1}</td>
            <td>${r.timestamp||''}</td>
            <td><strong>${r.promo_code||''}</strong></td>
            <td>${r.name||''}</td>
            <td>${r.start_date||''}</td>
            <td>${r.end_date||''}</td>
            <td>${r.channel||''}</td>
            <td>${r.budget||''}</td>
            <td>${r.discount||''}</td>
            <td>${r.owner||''}</td>
            <td>${(r.notes||'').toString().slice(0,120)}</td>
            <td><span class="status ${stClass}">${r.status||''}</span></td>
            <td class="tbl-actions">
              <button onclick="quickUpdateStatus(${rowIndexOneBased}, 'Approved')">Approve</button>
              <button onclick="quickUpdateStatus(${rowIndexOneBased}, 'Done')">Done</button>
            </td>
          </tr>`;
        }).join(''),
        '</tbody></table></div>'
      ].join('');

      $('#list').innerHTML = html;
    }

    async function quickUpdateStatus(rowIndexOneBased, newStatus){
      try{
        const res = await fetch(WEB_APP_URL, {
          method: 'POST',
          headers: {'Content-Type':'text/plain'}, // simple request
          body: JSON.stringify({ action:'update', rowIndexOneBased, data: { status: newStatus } })
        });
        const json = await res.json();
        if(!json.ok) throw new Error(json.error||'Update failed');
        showToast('Updated ✓');
        await listPromos();
      }catch(err){
        alert('Update error: '+err.message);
      }
    }

    $('#f').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const fd = new FormData(e.target);
      const data = Object.fromEntries(fd.entries());
      showToast('Saving…', true);
      try{
        const res = await fetch(WEB_APP_URL, {
          method: 'POST',
          headers: {'Content-Type':'text/plain'}, // simple request
          body: JSON.stringify({ action: 'add', data })
        });
        const json = await res.json();
        if(!json.ok) throw new Error(json.error||'Save failed');
        showToast('Saved ✓');
        e.target.reset();
        listPromos();
      }catch(err){
        showToast('Error: '+err.message);
      }
    });

    $('#q').addEventListener('input', ()=> renderTable(window.__rows||[]));

    function showToast(text, stay=false){
      const el = $('#msg');
      el.textContent = text;
      el.classList.add('show');
      if(!stay){
        setTimeout(()=>el.classList.remove('show'), 1500);
      }
    }

    listPromos();
  </script>
</body>
</html>
