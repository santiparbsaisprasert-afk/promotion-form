<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Promotion Header</title>
<style>
  :root{
    --bg:#f5f7fb; --panel:#fff; --head:#0b67c2; --head-text:#fff;
    --label-bg:#e9eef7; --label:#2b3b56; --border:#cfd7e6; --muted:#6b778b;
    --radius:10px; --accent:#0b67c2;
  }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:#1d2430;font-family:Segoe UI,Roboto,system-ui,Arial}
  .container{max-width:1200px;margin:24px auto;padding:0 16px}

  /* Top bar */
  .topbar{display:grid;grid-template-columns:1fr 1fr 1fr 140px;gap:12px;align-items:end;margin-bottom:12px}
  .topbar .field label{display:block;font-weight:600;margin:0 0 6px;color:#2b3b56}
  .topbar input{width:100%}
  .actions-v{display:flex;flex-direction:column;gap:10px;align-self:start}
  .actions-v .btn{width:100%}

  /* Main 2 columns — ขวากว้างขึ้น */
  .main{display:grid;grid-template-columns:3fr 2fr;gap:16px}
  @media (max-width:1000px){ .main{grid-template-columns:1fr} .actions-v{flex-direction:row} }

  .panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;overflow:hidden}
  .panel .head{background:var(--head);color:var(--head-text);padding:10px 12px;font-weight:700}
  .panel .body{padding:12px}

  /* Two-column rows (label cell + input cell) */
  .rows{display:grid;gap:8px}
  .row{display:grid;grid-template-columns:220px 1fr;gap:10px;align-items:center}
  @media (max-width:720px){ .row{grid-template-columns:160px 1fr} }
  .label{background:var(--label-bg);color:var(--label);border:1px solid var(--border);border-radius:8px;padding:9px 10px;font-weight:600}
  .cell{display:flex;gap:8px;align-items:center}

  input[type="text"], input[type="date"], input[type="number"], select, textarea{
    width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:8px;background:#fff;outline:none
  }
  textarea{min-height:92px;resize:vertical}
  input:focus, select:focus, textarea:focus{border-color:#96b6e8;box-shadow:0 0 0 3px rgba(11,103,194,.15)}

  .inline{display:grid;grid-template-columns:1fr auto 1fr auto;gap:8px;align-items:center}
  .inline small{color:var(--muted)}

  .chips{display:flex;flex-wrap:wrap;gap:6px}
  .chip{background:#eef4ff;border:1px solid var(--border);padding:4px 8px;border-radius:999px;font-size:12px}

  .btn{border:1px solid var(--border);background:#fff;color:#1d2430;padding:10px 12px;border-radius:8px;cursor:pointer}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  .btn.ghost{background:#f3f6fb}
  .btn.danger{background:#fef2f2;border-color:#f4caca;color:#9f1239}

  /* Search table */
  table{width:100%;border-collapse:separate;border-spacing:0;margin-top:10px;background:#fff;border:1px solid var(--border);border-radius:12px;overflow:hidden}
  th,td{padding:10px;border-bottom:1px solid #edf1f7;text-align:left}
  thead th{background:#f3f6fb;color:#36455f;font-weight:700}
  tr:last-child td{border-bottom:0}
  .muted{color:var(--muted);font-size:12px}
  .toast{display:none;font-size:12px;background:#e7f7ea;color:#116736;border:1px solid #b3e2c1;border-radius:8px;padding:6px 10px}
  .toast.show{display:inline-block}

  /* Right panel tuning */
  .mechanic-box{height:380px}
  .right .body .row .cell input,
  .right .body .row .cell select,
  .right .body .row .cell textarea{padding:10px 12px}
</style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="topbar">
      <div class="field"><label>Memo No.*</label><input id="memo_no_top" placeholder="Required"/></div>
      <div class="field"><label>Calendar Name</label><input id="calendar_name_top"/></div>
      <div class="field"><label>Event Name</label><input id="event_name_top"/></div>
      <div class="actions-v">
        <button class="btn">Close</button>
        <button class="btn ghost" id="btnClear">Clear Form</button>
        <button class="btn primary" id="btnSubmit">Submit</button>
        <button class="btn ghost" id="btnJumpSearch">Search</button>
      </div>
    </div>

    <div class="main">
      <!-- Left -->
      <div class="panel">
        <div class="head">Promotion Details</div>
        <div class="body rows">
          <div class="row"><div class="label">Promotion Code</div><div class="cell"><input id="promotion_code" placeholder="Enter your code here"/></div></div>
          <div class="row"><div class="label">Payment Code</div><div class="cell"><input id="payment_code"/></div></div>

          <div class="row">
            <div class="label">Date of Issue</div>
            <div class="cell inline">
              <input type="date" id="date_of_issue"/><small></small>
              <label class="muted" style="justify-self:end">Contact Name</label>
              <input id="contact_name"/>
            </div>
          </div>

          <div class="row">
            <div class="label">Promotion Period</div>
            <div class="cell inline">
              <input type="date" id="start_date"/><small>to</small><input type="date" id="end_date"/><small>- <span id="days">0</span> Days</small>
            </div>
          </div>

          <div class="row"><div class="label">Campaign</div><div class="cell"><input id="campaign"/></div></div>
          <div class="row"><div class="label">Target Group</div><div class="cell"><input id="target_group"/></div></div>

          <div class="row">
            <div class="label">Category</div>
            <div class="cell" style="flex-direction:column;gap:8px;align-items:stretch">
              <div class="inline" style="grid-template-columns: 190px auto auto auto;">
                <select id="category_mode">
                  <option value="ALL">All Category</option>
                  <option value="INCLUDE_SOME">Some Categories join</option>
                  <option value="EXCLUDE_SOME">Some Categories NOT join</option>
                </select><div></div><button class="btn" id="pickCat">Select Categories</button>
              </div>
              <div class="chips" id="chipsCat" data-values=""></div>
            </div>
          </div>

          <div class="row">
            <div class="label">Brand</div>
            <div class="cell" style="flex-direction:column;gap:8px;align-items:stretch">
              <div class="inline" style="grid-template-columns: 190px auto auto auto;">
                <select id="brand_mode">
                  <option value="ALL">All Brand</option>
                  <option value="INCLUDE_SOME">Some Brands join</option>
                  <option value="EXCLUDE_SOME">Some Brands NOT join</option>
                </select><div></div><button class="btn" id="pickBrand">Select Brands</button>
              </div>
              <div class="chips" id="chipsBrand" data-values=""></div>
            </div>
          </div>

          <div class="row"><div class="label">Background</div><div class="cell"><textarea id="background"></textarea></div></div>
          <div class="row"><div class="label">Location</div><div class="cell"><input id="location"/></div></div>
          <div class="row"><div class="label">Objectives</div><div class="cell"><select id="objective"></select></div></div>
          <div class="row"><div class="label">Target</div><div class="cell"><input id="target_text"/></div></div>
        </div>
      </div>

      <!-- Right -->
      <div class="panel right">
        <div class="head">Mechanic</div>
        <div class="body rows">
          <div class="row"><div class="label">Mechanic</div><div class="cell"><select id="mechanic_type"></select></div></div>
          <div class="row"><div class="label">Details</div><div class="cell"><textarea id="context_long" class="mechanic-box"></textarea></div></div>
          <div class="row"><div class="label">In Budget</div><div class="cell"><input type="number" id="in_budget" min="0" step="0.01" placeholder="0.00"/></div></div>
          <div class="row"><div class="label">Request Extra Budget</div><div class="cell"><input type="checkbox" id="chkExtra" style="width:auto"/><input type="number" id="extra_budget_amount" min="0" step="0.01" placeholder="0.00" style="max-width:200px;display:none"/></div></div>
          <div class="row"><div class="label">Total</div><div class="cell"><input id="total" readonly/></div></div>
          <div class="row"><div class="label">Status</div><div class="cell"><span class="toast" id="toast">Saved ✓</span></div></div>
        </div>
      </div>
    </div>

    <!-- Search -->
    <div class="panel" style="margin-top:16px">
      <div class="head">Search</div>
      <div class="body">
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px">
          <input id="q" placeholder="memo / event / promotion code / objective / mechanic" style="flex:1"/>
          <button class="btn" id="btnSearch">Search</button>
          <span class="muted" id="countPill">0 results</span>
        </div>
        <div id="searchList"></div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div id="modal" style="position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:20px">
    <div style="max-width:640px;width:100%;background:#fff;border:1px solid var(--border);border-radius:12px;padding:14px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong id="modalTitle">Select</strong>
        <button class="btn danger" id="closeModal">Close</button>
      </div>
      <input id="modalFilter" placeholder="type to filter..." style="margin:10px 0;width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:8px"/>
      <div id="modalList" style="max-height:360px;overflow:auto;border:1px solid var(--border);border-radius:10px;padding:8px"></div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
        <button class="btn primary" id="applyPick">Apply</button>
        <small class="muted" id="modalCount"></small>
      </div>
    </div>
  </div>

<script>
  /* ========= CONFIG ========= */
  const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzodTKajuEeNkui75dL9x8zeUb15IF0F66ONFpbRJN0Ie4UqO_ly9iA-92tue_VWe_TtQ/exec';

  /* ========= UTILS ========= */
  const $ = s => document.querySelector(s);
  const join = a => (a||[]).join('|'); const split = s => (s||'').split('|').map(x=>x.trim()).filter(Boolean);
  const daysBetween=(s,e)=>{ if(!s||!e) return 0; const sd=new Date(s+'T00:00:00Z'); const ed=new Date(e+'T00:00:00Z'); const d=Math.floor((ed-sd)/86400000)+1; return d>0?d:0; };
  async function apiGET(p){ const u=WEB_APP_URL+'?'+new URLSearchParams(p).toString(); const r=await fetch(u); return r.json(); }
  async function apiPOST(body){ const r=await fetch(WEB_APP_URL,{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify(body)}); return r.json(); }
  const toast=t=>{ const el=$('#toast'); el.textContent=t; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),1500); };

  /* ========= LOOKUPS ========= */
  let LOOKUPS={categories:[],brands:[],objectives:[],mechanics:[]};
  async function loadLookups(){
    const js=await apiGET({fn:'lookups'}); if(!js.ok) throw new Error(js.error||'lookup error');
    LOOKUPS=js.data;
    $('#objective').innerHTML='<option value=""></option>'+LOOKUPS.objectives.map(x=>`<option>${x}</option>`).join('');
    $('#mechanic_type').innerHTML='<option value=""></option>'+LOOKUPS.mechanics.map(x=>`<option>${x}</option>`).join('');
    updateModeButtons();
  }

  /* ========= PICKER ========= */
  let PICK={type:'category', set:new Set(), source:[]};
  function openPick(type){
    PICK.type=type;
    PICK.source=(type==='category'?LOOKUPS.categories:LOOKUPS.brands).slice();
    const cur=split((type==='category'?$('#chipsCat'):$('#chipsBrand')).dataset.values||''); PICK.set=new Set(cur);
    $('#modalTitle').textContent='Select '+(type==='category'?'Categories':'Brands');
    $('#modalFilter').value=''; renderPick(); $('#modal').style.display='flex';
  }
  function renderPick(){
    const q=$('#modalFilter').value.toLowerCase().trim();
    const items=PICK.source.filter(x=>!q||x.toLowerCase().includes(q));
    $('#modalList').innerHTML=items.map(n=>{
      const chk=PICK.set.has(n)?'checked': '';
      return `<label style="display:flex;gap:8px;align-items:center;padding:6px">
        <input type="checkbox" ${chk} onchange="togglePick('${n.replace(/'/g,"\\'")}')"/><span>${n}</span></label>`;
    }).join('') || '<div class="muted">No items</div>';
    $('#modalCount').textContent=`${PICK.set.size} selected`;
  }
  window.togglePick=(n)=>{ if(PICK.set.has(n)) PICK.set.delete(n); else PICK.set.add(n); $('#modalCount').textContent=`${PICK.set.size} selected`; };
  $('#applyPick').onclick=()=>{
    const list=Array.from(PICK.set); const html=list.map(x=>`<span class="chip">${x}</span>`).join('');
    if (PICK.type==='category'){ $('#chipsCat').dataset.values=join(list); $('#chipsCat').innerHTML=html; }
    else { $('#chipsBrand').dataset.values=join(list); $('#chipsBrand').innerHTML=html; }
    $('#modal').style.display='none';
  };
  $('#closeModal').onclick=()=>$('#modal').style.display='none';
  $('#modalFilter').addEventListener('input', renderPick);
  $('#pickCat').onclick=()=>openPick('category'); $('#pickBrand').onclick=()=>openPick('brand');

  function updateModeButtons(){
    const cm=$('#category_mode').value; $('#pickCat').disabled=(cm==='ALL'); if(cm==='ALL'){ $('#chipsCat').innerHTML=''; $('#chipsCat').dataset.values=''; }
    const bm=$('#brand_mode').value; $('#pickBrand').disabled=(bm==='ALL'); if(bm==='ALL'){ $('#chipsBrand').innerHTML=''; $('#chipsBrand').dataset.values=''; }
  }
  $('#category_mode').addEventListener('change', updateModeButtons);
  $('#brand_mode').addEventListener('change', updateModeButtons);

  /* ========= CALC ========= */
  function recalcDays(){ $('#days').textContent = daysBetween($('#start_date').value,$('#end_date').value); }
  function recalcTotal(){
    const base=parseFloat($('#in_budget').value||'0')||0;
    const exOn=$('#chkExtra').checked; $('#extra_budget_amount').style.display=exOn?'inline-block':'none';
    const extra=exOn ? (parseFloat($('#extra_budget_amount').value||'0')||0) : 0;
    $('#total').value=(base+extra).toFixed(2);
  }
  $('#start_date').addEventListener('change', recalcDays);
  $('#end_date').addEventListener('change', recalcDays);
  $('#in_budget').addEventListener('input', recalcTotal);
  $('#chkExtra').addEventListener('change', recalcTotal);
  $('#extra_budget_amount').addEventListener('input', recalcTotal);

  /* ========= COLLECT / SAVE ========= */
  function collect(){
    return {
      memo_no: $('#memo_no_top').value.trim(),
      calendar_name: $('#calendar_name_top').value.trim(),
      event_name: $('#event_name_top').value.trim(),
      promotion_code: $('#promotion_code').value.trim(),
      payment_code: $('#payment_code').value.trim(),
      date_of_issue: $('#date_of_issue').value,
      start_date: $('#start_date').value,
      end_date: $('#end_date').value,
      days: Number($('#days').textContent||'0')||'',
      campaign: $('#campaign').value.trim(),
      target_group: $('#target_group').value.trim(),
      category_mode: $('#category_mode').value,
      category_list: $('#chipsCat').dataset.values||'',
      brand_mode: $('#brand_mode').value,
      brand_list: $('#chipsBrand').dataset.values||'',
      background: $('#background').value,
      location: $('#location').value.trim(),
      objective: $('#objective').value,
      target_text: $('#target_text').value.trim(),
      mechanic_type: $('#mechanic_type').value,
      in_budget: $('#in_budget').value,
      extra_budget_checked: $('#chkExtra').checked,
      extra_budget_amount: $('#extra_budget_amount').value,
      total: $('#total').value,
      context_long: $('#context_long').value,
      contact_name: $('#contact_name').value,
      created_by: 'web', updated_by: 'web'
    };
  }
  let MODE='create';
  $('#btnSubmit').onclick=async ()=>{
    const d=collect();
    if(!d.memo_no){ alert('Memo No. is required'); return; }
    if(!d.date_of_issue||!d.start_date||!d.end_date){ alert('Date of Issue / Start / End is required'); return; }
    if(new Date(d.end_date)<new Date(d.start_date)){ alert('End date must be >= Start date'); return; }
    try{
      const js=await apiPOST({action:'save',mode:MODE,data:d});
      if(!js.ok) throw new Error(js.error||'save failed');
      toast('Saved ✓'); MODE='update'; doSearch();
    }catch(err){ alert(err.message); }
  };

  /* ========= CLEAR ========= */
  $('#btnClear').onclick=()=>{
    document.querySelectorAll('input,textarea,select').forEach(el=>{
      if(el.type==='checkbox') el.checked=false; else el.value='';
    });
    $('#chipsCat').innerHTML=''; $('#chipsCat').dataset.values='';
    $('#chipsBrand').innerHTML=''; $('#chipsBrand').dataset.values='';
    $('#days').textContent='0'; $('#total').value=''; $('#extra_budget_amount').style.display='none';
    MODE='create';
  };

  /* ========= SEARCH ========= */
  async function doSearch(){
    $('#searchList').innerHTML='<div class="muted">Loading…</div>';
    const js=await apiGET({fn:'search',q:$('#q').value.trim()});
    if(!js.ok){ $('#searchList').innerHTML='<div class="muted">Error</div>'; return; }
    const rows=js.data||[]; $('#countPill').textContent=`${rows.length} results`;
    $('#searchList').innerHTML=[
      '<table><thead><tr>',
      '<th>Memo No.</th><th>Event</th><th>Period</th><th>Calendar</th><th>Objective</th><th>Mechanic</th><th>Total</th><th></th>',
      '</tr></thead><tbody>',
      rows.map(r=>`<tr>
        <td><b>${r.memo_no||''}</b></td>
        <td>${r.event_name||''}</td>
        <td>${r.period||''}</td>
        <td>${r.calendar_name||''}</td>
        <td>${r.objective||''}</td>
        <td>${r.mechanic_type||''}</td>
        <td>${r.total||''}</td>
        <td><button class="btn ghost" onclick="openMemo('${(r.memo_no||'').replace(/'/g,"\\'")}')">Open</button></td>
      </tr>`).join(''),
      '</tbody></table>'
    ].join('');
  }
  $('#btnSearch').onclick=doSearch;
  $('#btnJumpSearch').onclick=()=>{ window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'}); doSearch(); };

  window.openMemo=async (memo)=>{
    const js=await apiGET({fn:'get',memo_no:memo}); if(!js.ok||!js.data){ alert('Not found'); return; }
    const d=js.data;
    $('#memo_no_top').value=d.memo_no||''; $('#calendar_name_top').value=d.calendar_name||''; $('#event_name_top').value=d.event_name||'';
    $('#promotion_code').value=d.promotion_code||''; $('#payment_code').value=d.payment_code||'';
    $('#date_of_issue').value=d.date_of_issue||''; $('#start_date').value=d.start_date||''; $('#end_date').value=d.end_date||''; $('#days').textContent=d.days||'0';
    $('#campaign').value=d.campaign||''; $('#target_group').value=d.target_group||'';
    $('#category_mode').value=d.category_mode||'ALL'; $('#brand_mode').value=d.brand_mode||'ALL';
    $('#background').value=d.background||''; $('#location').value=d.location||'';
    $('#objective').value=d.objective||''; $('#target_text').value=d.target_text||'';
    $('#mechanic_type').value=d.mechanic_type||''; $('#in_budget').value=d.in_budget||''; $('#chkExtra').checked=String(d.extra_budget_checked).toLowerCase()==='true';
    $('#extra_budget_amount').value=d.extra_budget_amount||''; $('#total').value=d.total||''; $('#context_long').value=d.context_long||''; $('#contact_name').value=d.contact_name||'';

    const cat=split(d.category_list); $('#chipsCat').dataset.values=join(cat); $('#chipsCat').innerHTML=cat.map(x=>`<span class="chip">${x}</span>`).join('');
    const br=split(d.brand_list); $('#chipsBrand').dataset.values=join(br); $('#chipsBrand').innerHTML=br.map(x=>`<span class="chip">${x}</span>`).join('');

    updateModeButtons(); recalcTotal(); MODE='update'; window.scrollTo({top:0,behavior:'smooth'});
  };

  /* init */
  (async function(){ try{ await loadLookups(); }catch(e){ alert(e.message); } })();
</script>
</body>
</html>
