<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Promotion Portal</title>
<style>
  :root{
    --bg:#f6f8fc; --surface:#fff; --border:#e2e8f0; --subtle:#f1f5f9;
    --ink:#0f172a; --muted:#64748b; --brand:#1d4ed8; --brand-600:#2563eb;
    --brand-50:#eff6ff; --radius:12px; --shadow:0 1px 3px rgba(0,0,0,.06), 0 8px 24px rgba(15,23,42,.06);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.5 system-ui,-apple-system,"Segoe UI",Roboto,Arial}
  .page{max-width:1240px;margin:28px auto;padding:0 20px;display:grid;grid-template-columns:7fr 5fr;gap:20px}
  @media (max-width:1024px){ .page{grid-template-columns:1fr} }
  header{grid-column:1/-1;margin-bottom:4px}
  header h1{margin:0 0 6px;font-size:22px}
  header .sub{color:var(--muted);font-size:12px}

  .card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
  .card .hd{padding:10px 14px;background:var(--brand);color:#fff;font-weight:700}
  .card .bd{padding:14px}
  .right{display:grid;gap:20px;align-content:start;position:sticky;top:20px;height:fit-content}

  .rows{display:grid;gap:10px}
  .row{display:grid;grid-template-columns:200px 1fr;gap:12px;align-items:center}
  @media (max-width:720px){ .row{grid-template-columns:150px 1fr} }
  .label{background:var(--subtle);border:1px solid var(--border);border-radius:10px;padding:10px;font-weight:600;color:#334155}
  .cell{display:flex;gap:10px;align-items:center}
  .cell>*{flex:1 1 100%;min-width:0}
  input[type="text"],input[type="date"],input[type="number"],select,textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff;outline:none}
  textarea{min-height:96px;resize:vertical}
  input:focus,select:focus,textarea:focus{border-color:var(--brand-600);box-shadow:0 0 0 3px rgba(37,99,235,.16)}
  .inline{display:grid;grid-template-columns:1fr auto 1fr auto;gap:10px;align-items:center}
  .inline small{color:var(--muted);white-space:nowrap}

  .chips{display:flex;flex-wrap:wrap;gap:6px;min-height:26px}
  .chip{background:var(--brand-50);border:1px solid var(--border);padding:4px 8px;border-radius:999px;font-size:12px}
  .placeholder{color:var(--muted);font-size:12px}

  .btn{border:1px solid var(--border);background:#fff;color:var(--ink);padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
  .btn.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
  .btn.block{width:100%}
  .btn.ghost{background:var(--subtle)}
  .actions .bd{display:grid;gap:10px}

  .mechanic-box{height:360px}

  .toolbar{display:flex;gap:10px;align-items:center;margin-bottom:10px}
  .toolbar .grow{flex:1}
  table{width:100%;border-collapse:separate;border-spacing:0;background:#fff;border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow)}
  thead th{background:var(--subtle);color:#334155;font-weight:700}
  th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left}
  tr:last-child td{border-bottom:0}

  .toast{display:none;font-size:12px;background:#e7f7ea;color:#0f5132;border:1px solid #b3e2c1;padding:6px 10px;border-radius:10px}
  .toast.show{display:inline-block}
  .muted{color:var(--muted);font-size:12px}
  .error{color:#b91c1c;font-size:12px}
</style>
</head>
<body>
  <div class="page">
    <header>
      <h1>Promotion Portal</h1>
      <div class="sub">GitHub Pages + Google Apps Script + Google Sheets</div>
    </header>

    <!-- LEFT -->
    <section class="card">
      <div class="hd">Promotion Details</div>
      <div class="bd rows">
        <div class="row">
          <div class="label">Memo No.*</div>
          <div class="cell">
            <input id="memo_no" placeholder="Required"/>
            <span id="memoBadge" class="muted" style="flex:0 0 auto"></span>
          </div>
        </div>
        <div class="row"><div class="label">Calendar Name</div><div class="cell"><input id="calendar_name"/></div></div>
        <div class="row"><div class="label">Event Name</div><div class="cell"><input id="event_name"/></div></div>

        <div class="row"><div class="label">Promotion Code</div><div class="cell"><input id="promotion_code" placeholder="AA123/BB456"/></div></div>
        <div class="row"><div class="label">Payment Code</div><div class="cell"><input id="payment_code"/></div></div>

        <div class="row">
          <div class="label">Date of Issue*</div>
          <div class="cell inline">
            <input type="date" id="date_of_issue"><small></small>
            <label class="muted" style="justify-self:end">Contact</label>
            <input id="contact_name" placeholder="Contact name">
          </div>
        </div>

        <div class="row">
          <div class="label">Promotion Period*</div>
          <div class="cell inline">
            <input type="date" id="start_date"><small>to</small>
            <input type="date" id="end_date"><small>— <span id="days">0</span> Days</small>
          </div>
        </div>

        <div class="row"><div class="label">Campaign</div><div class="cell"><input id="campaign"/></div></div>
        <div class="row"><div class="label">Target Group</div><div class="cell"><input id="target_group"/></div></div>

        <div class="row">
          <div class="label">Category</div>
          <div class="cell" style="flex-direction:column;align-items:stretch;gap:8px">
            <div class="cell" style="gap:10px">
              <select id="category_mode" style="flex:0 0 260px">
                <option value="ALL">All Category</option>
                <option value="INCLUDE_SOME">Some Categories join</option>
                <option value="EXCLUDE_SOME">Some Categories NOT join</option>
              </select>
              <button class="btn" id="pickCat" style="flex:0 0 180px">Select Categories</button>
            </div>
            <div class="chips" id="chipsCat" data-values=""><span class="placeholder">No categories selected</span></div>
          </div>
        </div>

        <div class="row">
          <div class="label">Brand</div>
          <div class="cell" style="flex-direction:column;align-items:stretch;gap:8px">
            <div class="cell" style="gap:10px">
              <select id="brand_mode" style="flex:0 0 260px">
                <option value="ALL">All Brand</option>
                <option value="INCLUDE_SOME">Some Brands join</option>
                <option value="EXCLUDE_SOME">Some Brands NOT join</option>
              </select>
              <button class="btn" id="pickBrand" style="flex:0 0 180px">Select Brands</button>
            </div>
            <div class="chips" id="chipsBrand" data-values=""><span class="placeholder">No brands selected</span></div>
          </div>
        </div>

        <div class="row"><div class="label">Background</div><div class="cell"><textarea id="background" placeholder="Context / reasoning"></textarea></div></div>
        <div class="row"><div class="label">Location</div><div class="cell"><input id="location"/></div></div>
        <div class="row"><div class="label">Objectives</div><div class="cell"><select id="objective"></select></div></div>
        <div class="row"><div class="label">Target (text)</div><div class="cell"><input id="target_text"/></div></div>

        <div class="error" id="msgForm"></div>
      </div>
    </section>

    <!-- RIGHT -->
    <aside class="right">
      <section class="card actions">
        <div class="hd">Actions</div>
        <div class="bd">
          <button class="btn block" id="btnClear">Clear Form</button>
          <button class="btn primary block" id="btnSubmit">Submit</button>
          <button class="btn block" id="btnJumpSearch">Search</button>
          <span class="toast" id="toast">Saved ✓</span>
        </div>
      </section>

      <section class="card">
        <div class="hd">Mechanic</div>
        <div class="bd rows">
          <div class="row"><div class="label">Mechanic</div><div class="cell"><select id="mechanic_type"></select></div></div>
          <div class="row"><div class="label">Details</div><div class="cell"><textarea id="context_long" class="mechanic-box" placeholder="Describe mechanic / rules / exclusions"></textarea></div></div>
          <div class="row"><div class="label">In Budget</div><div class="cell"><input type="number" id="in_budget" min="0" step="0.01" placeholder="0.00"/></div></div>
          <div class="row"><div class="label">Request Extra</div><div class="cell"><input type="checkbox" id="chkExtra" style="flex:0 0 auto;width:auto"><input type="number" id="extra_budget_amount" min="0" step="0.01" placeholder="0.00" style="display:none;max-width:180px"></div></div>
          <div class="row"><div class="label">Total</div><div class="cell"><input id="total" readonly/></div></div>
        </div>
      </section>
    </aside>

    <!-- SEARCH -->
    <section class="card" style="grid-column:1/-1">
      <div class="hd">Search</div>
      <div class="bd">
        <div class="toolbar">
          <input id="q" class="grow" placeholder="memo / event / promotion code / objective / mechanic"/>
          <button class="btn" id="btnSearch">Search</button>
          <span class="muted" id="countPill">0 results</span>
          <span class="muted" id="msg" style="margin-left:auto"></span>
        </div>
        <div id="searchList"></div>
      </div>
    </section>
  </div>

  <!-- Modal -->
  <div id="modal" style="position:fixed;inset:0;background:rgba(15,23,42,.35);display:none;align-items:center;justify-content:center;padding:20px;z-index:50">
    <div style="max-width:680px;width:100%;background:#fff;border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);padding:16px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong id="modalTitle">Select</strong>
        <button class="btn ghost" id="closeModal">Close</button>
      </div>
      <input id="modalFilter" placeholder="type to filter..." style="margin:12px 0;width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px"/>
      <div id="modalList" style="max-height:360px;overflow:auto;border:1px solid var(--border);border-radius:10px;padding:8px"></div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
        <button class="btn primary" id="applyPick">Apply</button>
        <span class="muted" id="modalCount"></span>
      </div>
    </div>
  </div>

<script>
  /* ========= API ========= */
  const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwwV-1QtdDDNUY3w8b_m3K3dYCcjPaDy8of6S230YiDR5DAYbNWe5ON6Pt1qWfx1jTDrQ/exec';
  const $ = s => document.querySelector(s);
  const join = a => (a||[]).join('|'); const split = s => (s||'').split('|').map(x=>x.trim()).filter(Boolean);
  const daysBetween=(s,e)=>{ if(!s||!e) return 0; const sd=new Date(s+'T00:00:00Z'); const ed=new Date(e+'T00:00:00Z'); const d=Math.floor((ed-sd)/86400000)+1; return d>0?d:0; };
  async function apiGET(p){ const u=WEB_APP_URL+'?'+new URLSearchParams(p).toString(); const r=await fetch(u); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }
  async function apiPOST(body){ const r=await fetch(WEB_APP_URL,{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify(body)}); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }
  const toast=t=>{ const el=$('#toast'); el.textContent=t; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),1400); };

  /* ========= LOOKUPS ========= */
  let LOOKUPS={categories:[],brands:[],objectives:[],mechanics:[]};
  async function loadLookups(){
    const js=await apiGET({fn:'lookups'}); LOOKUPS=js.data||{};
    $('#objective').innerHTML='<option value=""></option>'+ (LOOKUPS.objectives||[]).map(x=>`<option>${x}</option>`).join('');
    $('#mechanic_type').innerHTML='<option value=""></option>'+ (LOOKUPS.mechanics||[]).map(x=>`<option>${x}</option>`).join('');
    updateModeButtons();
  }

  /* ========= PICKERS ========= */
  let PICK={type:'category', set:new Set(), source:[]};
  function openPick(type){
    PICK.type=type;
    PICK.source=(type==='category'?LOOKUPS.categories:LOOKUPS.brands)||[];
    const cur=split((type==='category'?$('#chipsCat'):$('#chipsBrand')).dataset.values||'');
    PICK.set=new Set(cur);
    $('#modalTitle').textContent='Select '+(type==='category'?'Categories':'Brands');
    $('#modalFilter').value=''; renderPick(); $('#modal').style.display='flex';
  }
  function renderPick(){
    const q=$('#modalFilter').value.toLowerCase().trim();
    const items=PICK.source.filter(x=>!q||x.toLowerCase().includes(q));
    $('#modalList').innerHTML = items.map(n=>{
      const checked=PICK.set.has(n)?'checked':'';
      return `<label style="display:flex;gap:8px;align-items:center;padding:6px">
        <input type="checkbox" ${checked} onchange="togglePick('${n.replace(/'/g,"\\'")}')"/><span>${n}</span></label>`;
    }).join('') || '<div class="muted">No items</div>';
    $('#modalCount').textContent=`${PICK.set.size} selected`;
  }
  window.togglePick=(n)=>{ if(PICK.set.has(n)) PICK.set.delete(n); else PICK.set.add(n); $('#modalCount').textContent=`${PICK.set.size} selected`; };
  $('#applyPick').onclick=()=>{
    const list=Array.from(PICK.set); const html=list.map(x=>`<span class="chip">${x}</span>`).join('');
    if(PICK.type==='category'){ $('#chipsCat').dataset.values=join(list); $('#chipsCat').innerHTML=html||'<span class="placeholder">No categories selected</span>'; }
    else{ $('#chipsBrand').dataset.values=join(list); $('#chipsBrand').innerHTML=html||'<span class="placeholder">No brands selected</span>'; }
    $('#modal').style.display='none';
  };
  $('#closeModal').onclick=()=>$('#modal').style.display='none';
  $('#modalFilter').addEventListener('input', renderPick);
  $('#pickCat').onclick=()=>openPick('category'); $('#pickBrand').onclick=()=>openPick('brand');

  function updateModeButtons(){
    const cm=$('#category_mode').value; $('#pickCat').disabled=(cm==='ALL'); if(cm==='ALL'){ $('#chipsCat').dataset.values=''; $('#chipsCat').innerHTML='<span class="placeholder">All categories</span>'; }
    const bm=$('#brand_mode').value; $('#pickBrand').disabled=(bm==='ALL'); if(bm==='ALL'){ $('#chipsBrand').dataset.values=''; $('#chipsBrand').innerHTML='<span class="placeholder">All brands</span>'; }
  }
  $('#category_mode').addEventListener('change', updateModeButtons);
  $('#brand_mode').addEventListener('change', updateModeButtons);

  /* ========= Derive ========= */
  function recalcDays(){ $('#days').textContent=daysBetween($('#start_date').value,$('#end_date').value); }
  function recalcTotal(){
    const base=parseFloat($('#in_budget').value||'0')||0;
    const exOn=$('#chkExtra').checked; $('#extra_budget_amount').style.display=exOn?'inline-block':'none';
    const extra=exOn?(parseFloat($('#extra_budget_amount').value||'0')||0):0;
    $('#total').value=(base+extra).toFixed(2);
  }
  $('#start_date').addEventListener('change', recalcDays);
  $('#end_date').addEventListener('change', recalcDays);
  $('#in_budget').addEventListener('input', recalcTotal);
  $('#chkExtra').addEventListener('change', recalcTotal);
  $('#extra_budget_amount').addEventListener('input', recalcTotal);

  /* ========= Create/Update Mode ========= */
  let MODE = 'create';
  let CURRENT_RECORD = null;

  async function checkMemo(memo){
    const badge = $('#memoBadge');
    badge.textContent = '';
    if(!memo){ MODE='create'; CURRENT_RECORD=null; return; }
    try{
      const js = await apiGET({fn:'get', memo_no:memo});
      if(js.ok && js.data){
        badge.textContent = '• existing (update)'; badge.style.color = '#0e7490';
        MODE = 'update'; CURRENT_RECORD = js.data;
      }else{
        badge.textContent = '• new (create)'; badge.style.color = '#64748b';
        MODE = 'create'; CURRENT_RECORD = null;
      }
    }catch{/* ignore */}
  }
  let _memoTimer=null;
  $('#memo_no').addEventListener('input',(e)=>{ clearTimeout(_memoTimer); _memoTimer=setTimeout(()=>checkMemo(e.target.value.trim()),250); });
  $('#memo_no').addEventListener('blur',(e)=>checkMemo(e.target.value.trim()));

  /* ========= Save / Clear / Search ========= */
  function collect(){
    return {
      memo_no: $('#memo_no').value.trim(),
      calendar_name: $('#calendar_name').value.trim(),
      event_name: $('#event_name').value.trim(),
      promotion_code: $('#promotion_code').value.trim(),
      payment_code: $('#payment_code').value.trim(),
      date_of_issue: $('#date_of_issue').value,
      start_date: $('#start_date').value,
      end_date: $('#end_date').value,
      days: Number($('#days').textContent||'0')||'',
      campaign: $('#campaign').value.trim(),
      target_group: $('#target_group').value.trim(),
      category_mode: $('#category_mode').value,
      category_list: $('#chipsCat').dataset.values||'',
      brand_mode: $('#brand_mode').value,
      brand_list: $('#chipsBrand').dataset.values||'',
      background: $('#background').value,
      location: $('#location').value.trim(),
      objective: $('#objective').value,
      target_text: $('#target_text').value.trim(),
      mechanic_type: $('#mechanic_type').value,
      in_budget: $('#in_budget').value,
      extra_budget_checked: $('#chkExtra').checked,
      extra_budget_amount: $('#extra_budget_amount').value,
      total: $('#total').value,
      context_long: $('#context_long').value,
      contact_name: $('#contact_name').value,
      created_by: 'web', updated_by: 'web'
    };
  }

  $('#btnSubmit').onclick = async ()=>{
    $('#msgForm').textContent='';
    const d=collect();
    if(!d.memo_no){ $('#msgForm').textContent='Memo No. is required'; return; }
    if(!d.date_of_issue||!d.start_date||!d.end_date){ $('#msgForm').textContent='Date of Issue / Start / End is required'; return; }
    if(new Date(d.end_date) < new Date(d.start_date)){ $('#msgForm').textContent='End date must be >= Start date'; return; }

    $('#msg').textContent = (MODE==='update'?'Updating…':'Saving…');
    try{
      // ลองตามโหมดปัจจุบันก่อน
      let js = await apiPOST({action:'save', mode:MODE, data:d});
      if(!js.ok) throw new Error(js.error||'save failed');
      toast(MODE==='update'?'Updated ✓':'Saved ✓');
      $('#msg').textContent='Saved'; MODE='update'; doSearch();
      return;
    }catch(err){
      if(String(err.message).includes('duplicate_memo_no')){
        const ok = confirm('Memo นี้มีอยู่แล้ว ต้องการอัปเดตข้อมูลเดิมหรือไม่?');
        if(!ok){ $('#msg').textContent='Duplicate memo'; return; }
        try{
          const js2 = await apiPOST({action:'save', mode:'update', data:d});
          if(!js2.ok) throw new Error(js2.error||'update failed');
          toast('Updated ✓'); $('#msg').textContent='Updated'; MODE='update'; doSearch();
          return;
        }catch(e2){
          $('#msg').textContent='Error'; alert('Update failed: '+e2.message);
          return;
        }
      }
      $('#msg').textContent='Error'; alert('Failed to fetch: '+err.message);
    }
  };

  $('#btnClear').onclick=()=>{
    document.querySelectorAll('input,textarea,select').forEach(el=>{
      if(el.type==='checkbox') el.checked=false; else el.value='';
    });
    $('#chipsCat').innerHTML='<span class="placeholder">No categories selected</span>'; $('#chipsCat').dataset.values='';
    $('#chipsBrand').innerHTML='<span class="placeholder">No brands selected</span>'; $('#chipsBrand').dataset.values='';
    $('#days').textContent='0'; $('#total').value=''; $('#extra_budget_amount').style.display='none';
    $('#msgForm').textContent=''; $('#memoBadge').textContent=''; MODE='create';
  };

  async function doSearch(){
    $('#searchList').innerHTML='<div class="muted">Loading…</div>';
    try{
      const js=await apiGET({fn:'search',q:$('#q').value.trim()});
      const rows=js.data||[]; $('#countPill').textContent=`${rows.length} results`;
      $('#searchList').innerHTML=[
        '<table><thead><tr>',
        '<th>Memo No.</th><th>Event</th><th>Period</th><th>Calendar</th><th>Objective</th><th>Mechanic</th><th>Total</th><th></th>',
        '</tr></thead><tbody>',
        rows.map(r=>`<tr>
          <td><b>${r.memo_no||''}</b></td>
          <td>${r.event_name||''}</td>
          <td>${r.period||''}</td>
          <td>${r.calendar_name||''}</td>
          <td>${r.objective||''}</td>
          <td>${r.mechanic_type||''}</td>
          <td>${r.total||''}</td>
          <td><button class="btn" onclick="openMemo('${(r.memo_no||'').replace(/'/g,"\\'")}')">Open</button></td>
        </tr>`).join(''),
        '</tbody></table>'
      ].join('');
    }catch(err){
      $('#searchList').innerHTML='<div class="error">Failed to fetch: '+err.message+'</div>';
    }
  }
  $('#btnSearch').onclick=doSearch;
  $('#btnJumpSearch').onclick=()=>{ window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'}); doSearch(); };
  $('#q').addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); doSearch(); } });

  window.openMemo=async (memo)=>{
    try{
      const js=await apiGET({fn:'get',memo_no:memo}); if(!js.ok||!js.data){ alert('Not found'); return; }
      const d=js.data;
      ['memo_no','calendar_name','event_name','promotion_code','payment_code','date_of_issue','start_date','end_date','campaign','target_group','background','location','objective','target_text','mechanic_type','in_budget','extra_budget_amount','total','context_long','contact_name'].forEach(k=>{ const el=$('#'+k); if(el) el.value=d[k]||''; });
      $('#days').textContent=d.days||'0';
      $('#category_mode').value=d.category_mode||'ALL';
      $('#brand_mode').value=d.brand_mode||'ALL';
      $('#chkExtra').checked = String(d.extra_budget_checked).toLowerCase()==='true';

      const cat=split(d.category_list); $('#chipsCat').dataset.values=join(cat); $('#chipsCat').innerHTML=(cat.length?cat.map(x=>`<span class="chip">${x}</span>`).join(''):'<span class="placeholder">No categories selected</span>');
      const br=split(d.brand_list); $('#chipsBrand').dataset.values=join(br); $('#chipsBrand').innerHTML=(br.length?br.map(x=>`<span class="chip">${x}</span>`).join(''):'<span class="placeholder">No brands selected</span>');

      updateModeButtons(); recalcTotal(); MODE='update'; window.scrollTo({top:0,behavior:'smooth'});
    }catch(err){ alert('Failed to fetch: '+err.message); }
  };

  // init: ping + lookups + ดึงทั้งหมด
  (async function(){
    try{
      await apiGET({fn:'ping'});
      await loadLookups();
      $('#q').value=''; doSearch();
    }catch(err){
      alert('Failed to fetch: '+err.message+'\n\nตรวจสิทธิ์ Web App = Anyone และใช้ URL /exec ล่าสุด');
    }
  })();
</script>
</body>
</html>
